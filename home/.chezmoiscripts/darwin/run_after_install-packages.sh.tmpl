#!/bin/bash
# vim: syntax=sh

set -eufo pipefail

function brew_bundle() {
  echo "Run brew bundle..."
  brew bundle --no-lock --file={{ .brew.brewfilePath }}
}

function asdf_install() {
  echo "Installing software dependency versions via asdf..."
  while IFS= read -r plugin; do
    asdf plugin add "${plugin}" || true # ignore fail
    asdf install "${plugin}"
  done < <(cut -d " " -f1 < {{ .brew.toolVersionsPath }})

  asdf reshim
}

function get_current_date_utc() {
  date -u +{{ .brew.dateFormat | quote }}
}

function get_fallback_date_utc() {
  echo {{ .brew.fallbackDate | quote }}
}

function set_bundle_fallback_timestamp() {
  echo "Setting current timestamp in {{ .brew.bundleTimestampPath }}"
  get_fallback_date_utc > {{ .brew.bundleTimestampPath | quote }}
}

function set_bundle_timestamp() {
  echo "Setting current timestamp in {{ .brew.bundleTimestampPath }}"
  get_current_date_utc > {{ .brew.bundleTimestampPath | quote }}
}

function get_bundle_timestamp() {
  if ! [ -e {{ .brew.bundleTimestampPath | quote }} ]; then
    set_bundle_fallback_timestamp
  fi
  date -r {{ .brew.bundleTimestampPath }} +{{ .brew.dateFormat | quote }}
}

function get_brewfile_timestamp() {
  date -r {{ .brew.brewfilePath }} +{{ .brew.dateFormat | quote }}
}

function update_theme() {
  echo "You can update syntax highliting theme by running:"
  echo "fast-theme XDG:catppuccin-mocha"
}

function install_gh_extensions() {
  echo "Installing gh extensions..."
  {{ $ghToken := .gh.token -}}
  {{ range .packages.gh.extensions -}}
  GH_TOKEN={{ $ghToken }} gh extension install {{ . }}
  {{ end -}}
}

function main() {
  if [[ $(get_brewfile_timestamp) > $(get_bundle_timestamp) ]];
  then
    brew_bundle
    asdf_install
    set_bundle_timestamp;
  fi
  install_gh_extensions
  update_theme
}

main
